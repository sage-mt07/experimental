# diff_bars_20250916

対象: 足生成 DDL/ガイド整備（KEY_FORMAT 明示、DECIMAL/GroupBy注記）

## 変更概要
- 生成DDLの WITH 句に `KEY_FORMAT='AVRO'` を付与（キー定義がある場合）。
- `docs/chart-ddl.md` のDDL例に `KEY_FORMAT='AVRO'` を追記。
- DECIMAL の精度はアプリ依存である旨を明記（既定は 18,2／必要時はプロパティ単位で上書き）。
- GROUP BY への `WINDOWSTART` 明記は任意である旨を注記（投影での `WindowStart()` は1回必須）。
- ランタイム安定化: ToQueryで確定したTABLE型は OnModelCreating後に一括登録（ksqlDB TABLE一覧で存在確認）。起動順序を統一し、KafkaStream は Start 後に RUNNING を最大90秒待機。

## 変更ファイル
- src/Query/Pipeline/DDLQueryGenerator.cs
  - `GenerateCreateStream`/`GenerateCreateTable`: キー定義がある場合に `KEY_FORMAT='AVRO'` を追加。
- src/Query/Builders/KsqlCreateStatementBuilder.cs
  - CTAS/CSAS の WITH 句も、ソース型にキー定義がある場合のみ `KEY_FORMAT='AVRO'` を付与するよう変更。
- docs/chart-ddl.md
  - DDL例の WITH 句更新（KEY_FORMAT追記）。
  - 注意書き追加（DECIMAL=アプリ依存、GROUP BYのWINDOWSTARTは任意）。
- src/Cache/Extensions/KsqlContextCacheExtensions.cs
  - 既存TABLE/派生TABLEの登録経路を共通化。OnModelCreating後に RegisterEligibleTables で一括登録。
  - KafkaStream は Start→RUNNING待機 を確定順序化。
 - src/KsqlContext.SchemaRegistration.cs
  - RegisterEligibleTables を呼び出し、TABLEトピック一覧で存在確認してからキャッシュ登録。

## 動作・互換性
- 後方互換性は考慮不要との前提に基づく変更。
- ksqlDB への DDL適用において、KEY_FORMAT の明示は安全側の挙動。
- 既存の DECIMAL 既定（18,2）は維持。アプリ側で必要に応じて上書き。

## 移行メモ
- 既存環境で WITH 句に `KEY_FORMAT` がなかった場合でも、再作成・再適用時に `KEY_FORMAT` が付与されます。
- スキーマ名空間は現行方針（自動）を維持。SR登録名は環境に合わせて `VALUE_AVRO_SCHEMA_FULL_NAME` を設定してください。
